<html>
<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
<script type="text/javascript">
//hide some elements on startup
var myCurrent_page;
var myChoosedJob_id = "";
$(document).ready(function () {
    $("#Platform").hide();
	$("#PlatformButton").css('background-image','url(https://alamages.cern.ch/bf_button_fon_right_plus.png)');
	$("#SetupProject").hide();
	$("#SetupProjectButton").css('background-image','url(https://alamages.cern.ch/bf_button_fon_right_plus.png)');
	$(document.getElementsByName("{{ active_tab }}tab")).attr('id',   'selected');
	$("#dialog").hide();
	$("#cloneDialog").hide();
	doFilter({{ current_page}});
	$("#dialogClose").click(function () {$("#dialog").dialog("close");});
	$("#dialogCloneClose").click(function () { $("#cloneDialog").dialog("close"); });
	$("#goBackToDialog").click(function () { 
				$("#cloneDialog").dialog("close");
				openWindow(myChoosedJob_id); 	
			});
	$("#RunInDialog").click(function () { run(); });
	$("#UploadResultsInDialog").click(function () { uploadResults(); });
	$("#CloneInDialog").click(function () { openCloneWindow(myChoosedJob_id); });
	$("#commitClone").click(function () { alert("Commit new jobDescription id under construction..."); });
});

function showHide( button_id, box_id )
{
     $(document).ready(function() {
		// check visibility
		if ($(document.getElementById(box_id)).is(":hidden")) {
			// it's hidden - show it
				$(document.getElementById(box_id)).slideDown("slow");
				$(document.getElementById(button_id)).css('background-image','url(https://alamages.cern.ch/bf_button_fon_right.png)');
		} else {
			// it's not hidden - slide it down
				$(document.getElementById(box_id)).slideUp("slow");
				$(document.getElementById(button_id)).css('background-image','url(https://alamages.cern.ch/bf_button_fon_right_plus.png)');
			}
		});
}
function removeAllChilds(myId){
	var node= document.getElementById(myId);		
	if ( node.hasChildNodes() ){
   		while ( node.childNodes.length >= 1 ){
       			node.removeChild( node.firstChild );       
    	} 
	}	
	return;
}
function getSelectedChilds(id){
	nodes = document.getElementById(id).children;
	var sdValues = [];
	for(i=0; i<nodes.length; i+=1) {
    	if (nodes[i].children[0].children[0].checked == true){
			sdValues.push(nodes[i].children[0].children[0].value);
		}
	}
	return sdValues;
}
function clearCheckBox(id){
	var checked_existed;
	nodes = document.getElementById(id).children;
	for(i=0; i<nodes.length; i+=1) {
    	if (nodes[i].children[0].children[0].checked == true){
			nodes[i].children[0].children[0].checked = false;
			checked_existed = true;
		}
	}
	//call again the filters
	if (checked_existed)
		doFilter(1);
	return;
}
function addJobs(myId,box,apps){
	//loop over the array which contains the versions
	for(var i = 0; i < apps.length; i++)
	{
		var hrefObj = document.createElement("a");		
		var liObj = document.createElement("li");
		
		hrefObj.appendChild(document.createTextNode(apps[i].appName+" "+apps[i].appVersion+" "+apps[i].setupproject+" "+apps[i].options));
		liObj.appendChild(hrefObj);

		hrefObj.setAttribute('href','javascript:;');
		hrefObj.setAttribute('id', apps[i].pk);
			
		//extra function click
		hrefObj.setAttribute('onclick','openWindow(this.id)');
		box.appendChild(liObj);
	}
	return;
}
function doFilter(requested_page){
	box = document.getElementById("Jobs");

	var xmlhttp;    
	if (window.XMLHttpRequest){
		// code for IE7+, Firefox, Chrome, Opera, Safari
  		xmlhttp=new XMLHttpRequest();
  	}
	else{
		// code for IE6, IE5
  		xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  	}

	// when the response comes do...
	xmlhttp.onreadystatechange=function()
	{
  		if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{
			var jsondata = JSON.parse(xmlhttp.responseText);
			var jobs = jsondata.jobs;
			var pageInfo = jsondata.page_info;
			removeAllChilds("Jobs"); 
			addJobs("Jobs",box,jobs);
			
			removeAllChilds("pages");
			removeAllChilds("nextprevious");
			myCurrent_page = pageInfo.current_page;
			document.getElementById("pages").appendChild(document.createTextNode("Page "+pageInfo.current_page+" of "+pageInfo.num_of_pages));
			nextPrevious = document.getElementById("nextprevious");
			
			if (pageInfo.current_page > 1){
				Aprevious = document.createElement("a");
				Aprevious.setAttribute('href','javascript:;');
				var functionFilter = "doFilter("+(pageInfo.current_page-1)+")";
				Aprevious.setAttribute('onclick', functionFilter);
				Aprevious.appendChild(document.createTextNode("previous"));
				nextPrevious.appendChild(Aprevious);
				nextPrevious.appendChild(document.createTextNode(" | "));
			}
			if ( pageInfo.current_page < pageInfo.num_of_pages ){
				if (pageInfo.current_page <= 1)
					nextPrevious.appendChild(document.createTextNode(" | "));
				Anext = document.createElement("a");
				Anext.setAttribute('href','javascript:;');
				var functionFilter = "doFilter("+(pageInfo.current_page+1)+")";
				Anext.setAttribute('onclick', functionFilter);
				Anext.appendChild(document.createTextNode("next"));
				nextPrevious.appendChild(Anext);	
			}
			
			//fix the permalink
			permalink();
    	}	
  	}
	var setupprojects = getSelectedChilds("SetupProject");
	var appVersions = getSelectedChilds("Version");
	
	var options = getSelectedChilds("Options");
	var cmts = getSelectedChilds("Platform");	

	// send the request the to server
	xmlhttp.open("GET", "https://alamages.cern.ch/django/lhcbPR/getFilters?page="+requested_page+"&app={{ active_tab }}"+"&appVersions="+escape(appVersions.join(","))+"&SetupProjects="+escape(setupprojects.join(","))+"&Options="+escape(options.join(","))+"&platforms="+escape(cmts.join(",")), true);
	xmlhttp.send();
	
	return;
}
function permalink(){
	var setupprojects = getSelectedChilds("SetupProject");
	var appVersions = getSelectedChilds("Version");
	var options = getSelectedChilds("Options");
	var cmts = getSelectedChilds("Platform");	

	mypermalink = "?page="+myCurrent_page;
	if (appVersions.length >= 1)
		mypermalink+= "&appVersions="+escape(appVersions.join(","));
	if (setupprojects.length >=1)
		mypermalink+= "&SetupProjects="+escape(setupprojects.join(","));
	if (options.length >= 1)
		mypermalink+= "&Options="+escape(options.join(","));
	if (cmts.length >= 1)
		 mypermalink+= "&platforms="+escape(cmts.join(","));
	
	//location.hash = mypermalink;
	document.getElementById("mypermalink").href = window.location.href.split("?")[0]+mypermalink;
	
	return;
}

function openWindow(job_id){
	box = document.getElementById("Jobs");

	var xmlhttp;    
	if (window.XMLHttpRequest){
		// code for IE7+, Firefox, Chrome, Opera, Safari
  		xmlhttp=new XMLHttpRequest();
  	}
	else{
		// code for IE6, IE5
  		xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  	}

	// when the response comes do...
	xmlhttp.onreadystatechange=function()
	{
  		if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{
			var jsondata = JSON.parse(xmlhttp.responseText);
			mydialog = document.getElementById("dialog");
			mydialog.title=jsondata.appName+" job description details";
					
			document.getElementById("ApplicationDetails").value = jsondata.appName;
			document.getElementById("VersionDetails").value = jsondata.appVersion;
			document.getElementById("OptionsDetails").value = jsondata.options;
			document.getElementById("OptionsDDetails").value = jsondata.optionsD;
			document.getElementById("SetupProjectDetails").value = jsondata.setupProject;
			document.getElementById("SetupProjectDDetails").value = jsondata.setupProjectD;		
			
			removeAllChilds("platformsDetails");	
			mybox = document.getElementById("platformsDetails");
	
			for(var i = 0; i < jsondata.platforms.length; i++){
					myInput = document.createElement("input");
					myInput.type = "checkbox";	
					myInput.value = jsondata.platforms[i];
					myInput.setAttribute('readOnly','readonly');
					mybox.appendChild(myInput);
					mybox.appendChild(document.createTextNode(jsondata.platforms[i]));
					mybox.appendChild(document.createElement("br"));
					
			}
			myChoosedJob_id = job_id;
				$("#dialog").dialog({
    				resizable: false,
    				height: 700,
    				width: 950,
   					modal: true
				});
    	}	
  	}
	// send the request the to server
	xmlhttp.open("GET", "https://alamages.cern.ch/django/lhcbPR/getJobDetails?job_id="+job_id, true);
	xmlhttp.send();
	
	return;
}

function openCloneWindow(job_id){
	box = document.getElementById("Jobs");

	if (job_id == "")
		return;

	$("#dialog").dialog("close");

	var xmlhttp;    
	if (window.XMLHttpRequest){
		// code for IE7+, Firefox, Chrome, Opera, Safari
  		xmlhttp=new XMLHttpRequest();
  	}
	else{
		// code for IE6, IE5
  		xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  	}

	// when the response comes do...
	xmlhttp.onreadystatechange=function()
	{
  		if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{
			var jsondata = JSON.parse(xmlhttp.responseText);
			mydialog = document.getElementById("cloneDialog");
			mydialog.title="Add new "+jsondata.appName+" job description";
					
			document.getElementById("ApplicationClone").value = jsondata.appName;
			document.getElementById("VersionClone").value = jsondata.appVersion;
			document.getElementById("OptionsClone").value = jsondata.options;
			document.getElementById("OptionsDClone").value = jsondata.optionsD;
			document.getElementById("SetupProjectClone").value = jsondata.setupProject;
			document.getElementById("SetupProjectDClone").value = jsondata.setupProjectD;		
			
			removeAllChilds("platformsClone");	
			mybox = document.getElementById("platformsClone");
	
			for(var i = 0; i < jsondata.platforms.length; i++){
					myInput = document.createElement("input");
					myInput.type = "checkbox";	
					myInput.value = jsondata.platforms[i];
					
					mybox.appendChild(myInput);
					mybox.appendChild(document.createTextNode(jsondata.platforms[i]));
					mybox.appendChild(document.createElement("br"));
					
			}
				$("#cloneDialog").dialog({
    				resizable: false,
    				height: 700,
    				width: 600,
   					modal: true
				});
    	}	
  	}
	// send the request the to server
	xmlhttp.open("GET", "https://alamages.cern.ch/django/lhcbPR/getJobDetails?job_id="+job_id, true);
	xmlhttp.send();
	
	return;
}
function run(){
	alert("Run function, under construction...");
}
function uploadResults(){
	alert("Upload results function, under construction...");
}
</script>

<link rel="stylesheet" href="https://alamages.cern.ch/lhcbPR.css" media="screen">
<!-- <link rel="stylesheet" href="http://lhcb-release-area.web.cern.ch/LHCb-release-area/DOC/gauss/css/css.css" type="text/css" media="screen"> -->
<!-- <link rel="stylesheet" href="css.css" type="text/css" media="screen"> -->
<title>{{ active_tab }} job descriptions</title>
</HEAD>
<BODY>
<div class="ctitle">
<TABLE id="pagetitle">
<TBODY>
<TR>
<TD class=iconspace>
<A href="http://cern.ch/lhcb-comp">
<IMG id=lhcblogo  src="http://lhcb-release-area.web.cern.ch/LHCb-release-area/DOC/images/lhcbcomputinglogo.gif" >
</A>
</TD>
<TD vAlign=middle align=center>
<H1><a href="/django/lhcbPR" >LHCb Perfomance & Regression</a></H1>

<div style="float: right;">
{% if myauth %}
<a href="/django/lhcbPR/logout/?next=/django/lhcbPR"> Logout </a>| {{ user.username }}
{% else %}
<a href="/django/lhcbPR/login"> Login</a>
{% endif %}
</div><!-- closing div ^^-->

</TD>
</TR>
</TBODY>
</TABLE>
</div><!-- closing div class="ctitle"-->
<div class=pagebody >
<div id=manifest>
<p> Job Descriptions </p>
</div><!-- closing div id=manifest-->

<!-- <h2>Make your choices</h2> -->
<br>
<div id="header">
<ul>
	<!-- <li><a name="hometab" href="/django/lhcbPR/jobDescriptions">Home</a></li> -->
	{% for app in applications %}
	<li name="{{ app }}tab"><a href="/django/lhcbPR/jobDescriptions/{{ app }}">{{ app }}</a></li>
	{% endfor %}
</ul>

</div>

<div id="content">
<div style="overflow: auto;">
<a  id="mypermalink" href="" style="float : right; font-family: fantasy;" title="permalink" target="_blank"> Link to selection </a>
<div id="myfilter" style="float : left;">
<table class="sample">
<tr>
<td><a id="VersionButton" href="javascript:;"  class="bf_button" onclick='showHide(this.id,"Version")'><span>Version</span> </a>
<img id="erase_button" onclick='clearCheckBox("Version")' src="https://alamages.cern.ch/eraser2.png" title="clear checkbox" style="width: 20px; height: 20px;margin: 0 0 0 0.5em;cursor:pointer;"/></td>
<tr>
<td>
    <ul id="Version" name="Version" class="checklist"  >
	{% for ver in appVersions %}
		<li>
				<label id="Version{{ forloop.counter }}">
					<input id="Version{{ forloop.counter }}a" type="checkbox" value="{{ ver.value }}" onchange="doFilter(1)" {% if ver.checked %} checked="checked" {% endif %}>
						{{ ver.value }}
				 </label>
		</li>
	{% endfor %}
    </ul>
</td>
<tr>
<td><a id="OptionsButton" href="javascript:;"  class="bf_button" onclick='showHide(this.id,"Options")'><span>Options</span> </a>
<img id="erase_button" onclick='clearCheckBox("Options")' src="https://alamages.cern.ch/eraser2.png" title="clear checkbox" style="width: 20px; height: 20px;margin: 0 0 0 0.5em;cursor:pointer;"/></td>
<tr>
<td>
    <ul id="Options" name="Options" class="checklist" >
		{% for opt in options %}
		<li>
				<label id="Options{{ forloop.counter }}">
					<input id="Options{{ forloop.counter }}a" type="checkbox" value="{{ opt.value }}" onchange="doFilter(1)" {% if opt.checked %} checked="checked"  {% endif %}>
						{{ opt.value }}
				 </label>
		</li>
	{% endfor %}
</td>
<tr>
<td><a id="SetupProjectButton" href="javascript:;"  class="bf_button" onclick='showHide(this.id,"SetupProject")'><span>SetupProject</span> </a>
<img id="erase_button" onclick='clearCheckBox("SetupProject")' src="https://alamages.cern.ch/eraser2.png" title="clear checkbox" style="width: 20px; height: 20px;margin: 0 0 0 0.5em;cursor:pointer;"/></td> 
<tr>
<td>
    <ul id="SetupProject" name="SetupProject" class="checklist" >
	{% for setup in setupProject %}
		<li>
				<label id="SetupProject{{ forloop.counter }}">
					<input id="SetupProject{{ forloop.counter }}a" type="checkbox" value="{{ setup.value }}" onchange="doFilter(1)" {% if setup.checked %} checked="checked" {% endif %}>
						{{ setup.value }}
				 </label>
		</li>
	{% endfor %}
    </ul>
</td>
<tr>
<td><a id="PlatformButton" href="javascript:;"  class="bf_button" onclick='showHide(this.id,"Platform")'><span>Platform</span> </a>
<img id="erase_button" onclick='clearCheckBox("Platform")' src="https://alamages.cern.ch/eraser2.png" title="clear checkbox" style="width: 20px; height: 20px;margin: 0 0 0 0.5em;cursor:pointer;"/></td>
<tr>
<td>
    <ul id="Platform" name="Platform" class="checklist">
	{% for plat in platforms %}
		<li>
				<label id="Platform{{ forloop.counter }}">
					<input id="Platform{{ forloop.counter }}a" type="checkbox" value="{{ plat.value }}" onchange="doFilter(1)" {% if plat.checked %} checked="checked"  {% endif %}>
						{{ plat.value }}
				 </label>
		</li>
	{% endfor %}
    </ul>
</td>
</table>

</div><!-- closing div id=myfilter -->

<div style="float : middle; padding : 2em 0 0 15em;">
<div id="button">
<ul id="Jobs">
<ul>
</div><!-- closing button div ^^ -->
<span id="pages" style="font-family: Verdana;"></span><br> <!--  Page 1 of 1  -->
<span id="nextprevious"> </span> <!-- <a href="#">previous</a> | <a href="#" > next </a>  --> 
</div> <!-- same here -->
</div><!-- closing the scrollable div -->
</div><!-- closing div id=content-->
</div> <!-- closing div class=pagebody-->


<div id="dialog" title="" style="font-family:fantasy;">

<div id="JobDescriptionDetails" style="margin-top:0.5em;float:left;width:20em;height:25em;border-width: 1px;border-style: solid;border-radius: 1em; padding:2em;">
<table class="sample"><tr>
<td style="text-align:right;padding:0.5em;">Application:</td>
<td><input id="ApplicationDetails" type="text" value=""  readOnly="readonly" /></td><tr>
<td style="text-align:right;padding:0.5em;">Version:</td>
<td><input id="VersionDetails" type="text" value="" readOnly="readonly"/></td>
</table><br>
<table class="sample"><tr>
<td style="text-align:right;padding:0.5em;">Options:</td>
<td><input id="OptionsDetails"type="text" value="" readOnly="readonly" /></td><tr>
<td style="text-align:right;padding:0.5em;">Description:</td>
<td><input id="OptionsDDetails" type="text" value="" readOnly="readonly" /></td>
</table><br>
<table class="sample"><tr>
<td style="text-align:right;padding:0.5em;">SetupProject:</td>
<td><input id="SetupProjectDetails" type="text" value="" readOnly="readonly"/></td><tr>
<td style="text-align:right;padding:0.5em;">Description:</td>
<td><input id="SetupProjectDDetails" type="text" value="" readOnly="readonly"/></td>
</table><br>
<span>Requested platforms: </span>
<p id="platformsDetails" 
		style="width:14em;height:6.5em;margin-left:2em;">
</p>
</span>
</div> <!-- closing the JobDescriptionDetails-->

<br>
<!-- <span 
style="margin-left:1em;margin-top:10px;font-family:fantasy;font-size:20px;border-style:solid;border-width:1px;border-radius:1em;padding:10px;">Possible actions
</span><br><br> -->
<br><br>
<span style="margin-left:1.5em;"><button id="RunInDialog" type="button" style="padding: 10px">Run</button></span><br><br>
<span style="margin-left:1.5em;"><button id="CloneInDialog" type="button" style="padding: 10px">Clone</button></span><br><br>
<span style="margin-left:1.5em;"><button id="EditInDialog" type="button" style="padding: 10px">Edit</button></span><br><br>
<span style="margin-left:1.5em;"><button id="UploadResultsInDialog" type="button" style="padding: 10px">Upload results</button></span><br><br>
<span style="padding:2em;position:absolute;bottom:0;right:0;"><button id="dialogClose" type="button" style="padding: 10px;"
onclick="">Close</button></span>
</div> <!-- closing the  dialog -->


<div id="cloneDialog">
<div id="JobDescriptionClone" style="float:left;width:20em;height:25em;border-width: 1px;border-style: solid;border-radius: 1em; padding:2em;">
<table class="sample"><tr>
<td style="text-align:right;padding:0.5em;">Application:</td>
<td><input id="ApplicationClone" type="text" value=""  readOnly="readonly" /></td><tr>
<td style="text-align:right;padding:0.5em;">Version:</td>
<td><input id="VersionClone" type="text" value="" /></td>
</table><br>
<table class="sample"><tr>
<td style="text-align:right;padding:0.5em;">Options:</td>
<td><input id="OptionsClone"type="text" value="" /></td><tr>
<td style="text-align:right;padding:0.5em;">Description:</td>
<td><input id="OptionsDClone" type="text" value=""  /></td>
</table><br>
<table class="sample"><tr>
<td style="text-align:right;padding:0.5em;">SetupProject:</td>
<td><input id="SetupProjectClone" type="text" value="" /></td><tr>
<td style="text-align:right;padding:0.5em;">Description:</td>
<td><input id="SetupProjectDClone" type="text" value="" /></td>
</table><br>
<span>Requested platforms: </span>
<p id="platformsClone" 
		style="width:14em;height:6.5em;margin-left:2em;"><!-- border-style:solid;border-radius: 1em; border-width: 1px;-->
</p>
</span>
</div> <!-- closing the JobDescriptionDetails-->
<br>
<span style="margin-left: 1.5em;"><button id="commitClone" type="button" style="padding:10px;">Commit</button>
<span style="padding:2em;position:absolute;bottom:0;left:0;"><button id="goBackToDialog" type="button" style="padding: 10px;">Go back</button></span>
<span style="padding:2em;position:absolute;bottom:0;right:0;"><button id="dialogCloneClose" type="button" style="padding: 10px;">Close</button></span>
</div> <!-- /cloneDialog -->

</BODY>
</HTML>
